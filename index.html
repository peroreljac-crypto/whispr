<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="whispr.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>whispr</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

    html {
      height: 100%;
    }

    body {
      margin: 0;
      min-height: 100%;
      background: url('https://raw.githubusercontent.com/whisprcoin/whispr/refs/heads/main/5.png') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      font-family: 'VT323', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      letter-spacing: 1px;
      backdrop-filter: brightness(0.7) blur(1px);
    }
    
    h1 {
      font-size: 80px;
      margin-bottom: 10px;
    }

    p {
      color: #9c9c9c;
      font-size: 24px;
      margin: 3px;
    }

    small {
      color: #707070;
      font-size: 18px;
      margin-top: 25px;
    }

    .matrix-lines {
      position: fixed;
      width: 100%;
      height: 100%;
      background-image: repeating-linear-gradient(
        90deg,
        rgba(255, 255, 255, 0.02) 0px,
        rgba(255, 255, 255, 0.02) 1px,
        transparent 2px,
        transparent 4px
      );
      pointer-events: none;
      z-index: 0;
    }

    .content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      padding: 40px 0;
      flex-grow: 1;
      justify-content: center;
    }

    a {
      color: #9c9c9c;
      text-decoration: none;
      font-size: 20px;
      margin: 8px;
    }

    a:hover {
      color: #ffffff;
    }

    .footer-links {
      width: 100%;
      padding: 20px 0;
      text-align: center;
      z-index: 2;
    }

    .footer-links a {
      color: #9c9c9c;
      text-decoration: none;
      font-size: 20px;
      margin: 0 15px;
    }

    .footer-links a:hover {
      color: #ffffff;
    }

    .whispers {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      pointer-events: none;
      z-index: 0;
    }

    .whispers span {
      position: absolute;
      color: rgba(255, 255, 255, 0.25);
      font-size: 20px;
      font-family: 'VT323', monospace;
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.1);
      animation: whisperMove 15s linear infinite;
      opacity: 0;
      white-space: nowrap;
    }

    @keyframes whisperMove {
      0% { opacity: 0; transform: translateY(0); }
      10% { opacity: 0.4; }
      50% { opacity: 0.2; transform: translateY(-40px); }
      90% { opacity: 0; }
      100% { opacity: 0; transform: translateY(-80px); }
    }

    .shhh-ghost {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: rgba(255,255,255,0.28);
      font-family: 'VT323', monospace;
      font-size: 32px;
      letter-spacing: 1px;
      opacity: 0;
      pointer-events: none;
      z-index: 6;
      text-shadow: 0 0 6px rgba(255,255,255,0.10);
      transition: opacity 0.6s ease;
    }
    .shhh-ghost.show { opacity: 1; }

    .whisper-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 25px;
      margin-bottom: 25px;
      width: 100%;
    }

    #whisperInput {
      width: min(600px, 90vw);
      padding: 10px 12px;
      border: 1px solid #2a2a2a;
      background: rgba(12,12,12,.8);
      color: #eaeaea;
      font-family: 'VT323', monospace;
      font-size: 18px;
      outline: none;
      border-radius: 6px;
      transition: border-color .2s ease, background .2s ease;
    }
    #whisperInput::placeholder { color:#6f6f6f; }
    #whisperInput:focus {
      border-color:#555;
      background: rgba(18,18,18,.9);
    }

    #whisperSend {
      padding: 10px 14px;
      border: 1px solid #2a2a2a;
      background: rgba(18,18,18,.85);
      color:#cfcfcf;
      font-family: 'VT323', monospace;
      font-size:18px;
      border-radius:6px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, color .2s;
    }
    #whisperSend:hover { background:#1b1b1b; color:#fff; }
    #whisperSend:active { transform: translateY(1px); }
    #whisperSend[disabled] { opacity:.6; cursor:not-allowed; }

    .whisper-note {
      width: 100%;
      text-align: center;
      font-size: 14px;
      color:#6f6f6f;
      margin-top: 6px;
      opacity:.8;
    }

    .whisper-status {
      width:100%;
      text-align:center;
      font-size:16px;
      color:#a8ffa8;
      margin-top:8px;
      min-height: 1em;
      visibility: hidden;
    }
    .whisper-status.show { visibility: visible; }

    .content small {
      display: block;
      margin-top: 10px;
      font-size: 18px;
      color: rgba(255,255,255,0.65);
    }

    .color-row {
      margin-top:10px;
      display:flex; gap:10px; align-items:center; justify-content:center;
      color:#cfcfcf;
    }
    #colorWhisperBtn {
      padding:6px 10px;
      border-radius:6px;
      background:linear-gradient(90deg,#111,#222);
      color:#fff;
      border:1px solid rgba(255,255,255,0.06);
      font-family:'VT323', monospace;
      cursor: pointer;
    }
    #colorWhisperBtn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      background: #222;
    }
    #colorStatus { font-size:13px; color:#9c9c9c; }
    #checkStatusBtn {
      padding: 4px 8px; font-size: 13px; background: #222; border: 1px solid #333; color: #bbb; border-radius: 4px; font-family: 'VT323', monospace; cursor: pointer;
    }
    #checkStatusBtn:hover:not(:disabled) { background: #333; color: #fff; }
    #checkStatusBtn[disabled] { opacity: 0.6; cursor: not-allowed; }

    /* === STILOVI ZA WHISPRBOT === */
    .hidden { display: none !important; }
    #showAiBtn {
        margin-top: 20px;
        padding: 8px 16px;
        font-size: 18px;
        background: linear-gradient(90deg, #1a1a1a, #2b2b2b);
        border: 1px solid #a8ffa8;
        color: #a8ffa8;
        cursor: pointer;
        border-radius: 6px;
        font-family: 'VT323', monospace;
    }
    #ai-content { width: 100%; display: flex; flex-direction: column; align-items: center; }
    .ai-chat-container {
        margin-top: 20px;
        width: min(600px, 90vw);
        border: 1px solid #2a2a2a;
        background: rgba(10, 10, 10, 0.85);
        border-radius: 8px;
        padding: 15px;
        font-family: 'VT323', monospace;
    }
    .ai-chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .ai-chat-header h2 { margin: 0; font-size: 24px; color: #a8ffa8; }
    #hideAiBtn { background: none; border: none; font-size: 24px; color: #777; cursor: pointer; }
    #hideAiBtn:hover { color: #fff; }

    .ai-chat-history { height: 200px; overflow-y: auto; margin-bottom: 15px; padding-right: 10px; display: flex; flex-direction: column; gap: 10px; text-align: left; font-size: 16px; }
    .ai-chat-history p { font-size: 16px; margin: 0; }
    .ai-chat-history .user-q { color: #888; }
    .ai-chat-history .bot-a { color: #a8ffa8; }

    .ai-input-row { display: flex; gap: 10px; }
    #aiQuestionInput { flex-grow: 1; background: rgba(0,0,0,0.5); border: 1px solid #333; color: #eee; padding: 8px 10px; border-radius: 4px; font-family: 'VT323', monospace; font-size: 16px; }
    #aiQuestionInput:focus { outline: none; border-color: #555; }
    #aiAskButton { padding: 8px 12px; background: #222; border: 1px solid #333; color: #bbb; cursor: pointer; border-radius: 4px; font-family: 'VT323', monospace; font-size: 16px; }
    #aiAskButton:hover:not(:disabled) { background: #333; color: #fff; }
    #aiAskButton[disabled] { opacity: 0.5; cursor: not-allowed; }

    #aiStatus { font-size: 14px; color: #777; margin-top: 8px; min-height: 1em; text-align: left; }
    
    .ai-wallet-actions { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; align-items: center; }
    #aiConnectWalletBtn { padding: 6px 12px; font-size: 14px; background: #222; border: 1px solid #333; color: #bbb; border-radius: 4px; font-family: 'VT323', monospace; cursor: pointer; }
    #aiConnectWalletBtn:hover:not(:disabled) { background: #333; color: #fff; }
    #aiConnectWalletBtn[disabled] { opacity: 0.5; cursor: not-allowed; background: #111; color: #555; }
    .ai-check-status-row { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #9c9c9c; }
    #checkAiStatusBtn { padding: 4px 8px; font-size: 13px; background: #222; border: 1px solid #333; color: #bbb; border-radius: 4px; font-family: 'VT323', monospace; cursor: pointer; }
    #checkAiStatusBtn:hover:not(:disabled) { background: #333; color: #fff; }
    #checkAiStatusBtn[disabled] { opacity: 0.5; cursor: not-allowed; }

    .ai-sub-row { margin-top: 15px; text-align: center; }
    #aiSubButton { width: 100%; padding: 8px; font-size: 14px; background: linear-gradient(90deg, #1a1a1a, #2b2b2b); border: 1px solid #444; color: #a8ffa8; cursor: pointer; border-radius: 4px; font-family: 'VT323', monospace; }
    #aiSubButton[disabled] { opacity: 0.5; cursor: not-allowed; }
    #aiSubStatus { font-size: 13px; color: #9c9c9c; display: block; margin-top: 6px; min-height: 1em; }

    /* === STILOVI ZA TRENDING LISTU === */
    .trending-container {
      margin-top: 40px;
      width: min(450px, 90vw); /* Smanjena ≈°irina */
      background: rgba(10, 10, 10, 0.7); /* Poveƒáana prozirnost */
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 15px;
      font-family: 'VT323', monospace;
      color: #ccc;
      display: none; /* Sakriveno dok JS ne uƒçita podatke */
      text-align: center; /* Centriranje sadr≈æaja unutar boxa */
    }
    .trending-container.show { display: block; }
    .trending-container h3 {
      margin: 0 0 10px 0;
      font-size: 18px;
      color: #fff;
      text-align: center;
    }
    #trending-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
      font-size: 16px;
      counter-reset: trending-counter;
      text-align: left;
      display: inline-block;
    }
    #trending-list li {
      padding: 6px 0;
      border-bottom: 1px solid #222;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      counter-increment: trending-counter;
    }
    #trending-list li::before {
      content: counter(trending-counter) ". ";
      color: #666;
      margin-right: 8px;
    }
    #trending-list li:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <div class="matrix-lines"></div>
   <div class="whispers">
    <!-- Lebdeƒáe poruke se dodaju dinamiƒçki -->
  </div>
  
  <div class="content">
    
    <!-- === GLAVNI SADR≈ΩAJ (VIDLJIV ODMAH) === -->
    <div id="main-content">
      <h1>whispr</h1>
      <small>the value is in silence. üîá</small>
      
      <div class="whisper-box">
        <input id="whisperInput" type="text" maxlength="140" placeholder="send a whispr.">
        <button id="whisperSend" aria-label="send whisper">send üîá</button>
        <div class="whisper-note" aria-hidden="true">anonymous ¬∑ not saved</div>
        <div id="whisperStatus" class="whisper-status" aria-live="polite"></div>
      </div>
      
      <div class="color-row">
        <button id="colorWhisperBtn" type="button">‚ú® Get colored whispers ‚Äî 0.01 SOL / 24 h</button>
        <span id="colorStatus"></span>
      </div>
      
      <div class="color-row" style="margin-top: 8px; gap: 8px;">
        <span style="font-size: 13px; color: #9c9c9c;">Already paid?</span>
        <button id="checkStatusBtn" type="button">Check Status</button>
      </div>

      <button id="showAiBtn">Try WhisprBot AI</button>

      <!-- === TRENDING LISTA === -->
      <div id="trending-whispers" class="trending-container">
        <h3>Trending whisprs üîá</h3>
        <ol id="trending-list">
          <!-- Lista ƒáe biti popunjena putem JavaScripta -->
        </ol>
      </div>
    </div>

    <!-- === AI CHAT SADR≈ΩAJ (SKRIVEN) === -->
    <div id="ai-content" class="hidden">
      <div class="ai-chat-container">
        <div class="ai-chat-header">
          <h2>WhisprBot AI</h2>
          <button id="hideAiBtn" title="Back to main page">√ó</button>
        </div>
        <div id="aiChatHistory" class="ai-chat-history">
          <!-- Poruke se dodaju dinamiƒçki -->
        </div>
        <div class="ai-input-row">
          <input id="aiQuestionInput" type="text" placeholder="ask the silence...">
          <button id="aiAskButton">ask</button>
        </div>
        
        <div id="aiStatus" class="ai-status"></div>

        <div class="ai-wallet-actions">
            <button id="aiConnectWalletBtn">Connect Wallet</button>
            <div class="ai-check-status-row">
                <span>Already paid?</span>
                <button id="checkAiStatusBtn">Check Status</button>
            </div>
        </div>

        <div class="ai-sub-row">
          <button id="aiSubButton">Subscribe for unlimited answers ‚Äî 0.01 SOL / month</button>
          <span id="aiSubStatus"></span>
        </div>
      </div>
    </div>

  </div>

  <div class="footer-links">
    <a href="https://x.com/whisprcoin" target="_blank">x</a>
    <a href="#" target="_blank">solscan (soon)</a>
  </div>

  <script>
  // --- Animirani elementi (bez promjena) ---
  (function() {
    function spawnShhh(){
      const old = document.querySelector('.shhh-ghost');
      if (old) old.remove();
      const s = document.createElement('div');
      s.className = 'shhh-ghost';
      s.textContent = 'shhh...';
      document.body.appendChild(s);
      requestAnimationFrame(() => s.classList.add('show'));
      setTimeout(() => {
        s.classList.remove('show');
        setTimeout(() => s.remove(), 600);
      }, 1400);
    }
    const titleEl = document.querySelector('#main-content h1');
    if (titleEl){
      titleEl.addEventListener('mouseenter', spawnShhh);
      titleEl.addEventListener('touchstart', spawnShhh, {passive:true});
    }
  })();
</script>

<!-- Firebase & Solana SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-functions-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
<script src="./buffer-shim.js?v=1.0.1"></script>
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.2/lib/index.iife.min.js" crossorigin="anonymous"></script>

<script>
// --- Glavna skripta aplikacije ---
(function(){
  console.log('[whispr] boot');

  // Lightweight profanity filter
  const Filter=(function(){function e(e){this.list=e||[],this.placeHolder="*",this.regex=/@|\$|\\|\*/g,this.replaceRegex=/\w/g}return e.prototype.isProfane=function(e){for(var t=0;t<this.list.length;t++)if(new RegExp("\\b"+this.list[t].replace(/(\W)/g,"\\$1")+"\\b","gi").test(e))return!0;return!1},e.prototype.replaceWord=function(e){return e.replace(this.regex,"").replace(this.replaceRegex,this.placeHolder)},e.prototype.clean=function(e){return e.split(" ").map(function(e){return this.isProfane(e)?this.replaceWord(e):e}.bind(this)).join(" ")},e.prototype.addWords=function(){var e=Array.from(arguments);this.list=this.list.concat(e)},e.prototype.removeWords=function(){for(var e=Array.from(arguments),t=0;t<e.length;t++)for(var r=e[t],i=this.list.length-1;i>=0;i--)this.list[i]===r&&this.list.splice(i,1)},e})();

  window.addEventListener('load', function(){
    console.log('[whispr] dom ready');

    // --- Firebase & Cloud Functions Setup ---
    const firebaseConfig = {
      apiKey: "AIzaSyD1R-5ltVcfW8PiuoJ4d7Kt2kouIS0M4Do",
      authDomain: "whisprcoin.firebaseapp.com",
      databaseURL: "https://whisprcoin-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "whisprcoin",
      storageBucket: "whisprcoin.firebasestorage.app",
      messagingSenderId: "1063673504189",
      appId: "1:1063673504189:web:938b00b8a6871b0a5db2d4",
      measurementId: "G-ZYWYEXVG4F"
    };
    if (!window.firebase || !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const fns = firebase.app().functions('us-central1');
    const getPassStatus = fns.httpsCallable('getPassStatus');
    const getBlockhash = fns.httpsCallable('getBlockhash');
    const sendWhisperFn = fns.httpsCallable('sendWhisper');
    const confirmAndVerifyPayment = fns.httpsCallable('confirmAndVerifyPayment');
    const askWhisprBotFn = fns.httpsCallable('askWhisprBot');
    const confirmAndVerifyAiSubscription = fns.httpsCallable('confirmAndVerifyAiSubscription');

    // --- UI Elementi ---
    const mainContent = document.getElementById('main-content');
    const aiContent = document.getElementById('ai-content');
    const showAiBtn = document.getElementById('showAiBtn');
    const hideAiBtn = document.getElementById('hideAiBtn');
    
    const colorBtn = document.getElementById('colorWhisperBtn');
    const colorStatus = document.getElementById('colorStatus');
    const checkStatusBtn = document.getElementById('checkStatusBtn');

    const aiChatHistory = document.getElementById('aiChatHistory');
    const aiQuestionInput = document.getElementById('aiQuestionInput');
    const aiAskButton = document.getElementById('aiAskButton');
    const aiStatus = document.getElementById('aiStatus');
    const aiSubButton = document.getElementById('aiSubButton');
    const aiSubStatus = document.getElementById('aiSubStatus');
    const aiConnectWalletBtn = document.getElementById('aiConnectWalletBtn');
    const checkAiStatusBtn = document.getElementById('checkAiStatusBtn');

    const whisperInput = document.getElementById('whisperInput');
    const whisperSendBtn = document.getElementById('whisperSend');
    const whisperStatus = document.getElementById('whisperStatus');
    const whispersLayer = document.querySelector('.whispers');

    const trendingContainer = document.getElementById('trending-whispers');
    const trendingList = document.getElementById('trending-list');

    // --- Globalno stanje ---
    let userPubkey = null;
    let passActive = false;
    let passUntil  = 0;
    let aiSubActive = false;
    let aiSubUntil = 0;
    let freeMessagesUsed = 0;
    const AI_FREE_MESSAGE_LIMIT = 5;
    const profanityFilter = new Filter();
    // Dodajemo osnovne rijeƒçi, mo≈æe≈° pro≈°iriti listu
    profanityFilter.addWords('fuck', 'shit', 'bitch');

    // --- UI Toggling ---
    showAiBtn.addEventListener('click', () => {
      mainContent.classList.add('hidden');
      aiContent.classList.remove('hidden');
    });
    hideAiBtn.addEventListener('click', () => {
      aiContent.classList.add('hidden');
      mainContent.classList.remove('hidden');
    });

    // --- Wallet & Status Management ---
    
    async function connectWallet() {
        const provider = window.solana;
        if (!provider?.isPhantom) {
            alert('Phantom wallet is not installed.');
            return null;
        }
        try {
            const resp = await provider.connect();
            const pubkey = resp.publicKey.toString();
            console.log('[whispr] Wallet connected:', pubkey);
            userPubkey = pubkey;
            await refreshAllStatuses();
            return pubkey;
        } catch (err) {
            console.error('[whispr] Wallet connection failed:', err);
            userPubkey = null;
            updateAllUIs();
            return null;
        }
    }

    async function refreshAllStatuses() {
      if (!userPubkey) {
        updateAllUIs();
        return;
      }
      setLoadingState(true, 'checking status...');
      try {
        const { data } = await getPassStatus({ userPubkey });
        if (!data.ok) throw new Error(data.reason || 'Status check failed');
        
        console.log('[whispr] getPassStatus response:', data);
        passActive = !!data.colorPass?.active;
        passUntil  = data.colorPass?.active_until || 0;
        aiSubActive = !!data.aiSub?.active;
        aiSubUntil = data.aiSub?.active_until || 0;
        freeMessagesUsed = data.aiSub?.free_messages_used || 0;
      } catch (e) {
        console.error('[whispr] getPassStatus error:', e);
        colorStatus.textContent = 'status check failed';
        aiStatus.textContent = 'status check failed';
        passActive = false;
        aiSubActive = false;
      } finally {
        setLoadingState(false);
        updateAllUIs();
      }
    }

    function setLoadingState(isLoading, text = '') {
        checkStatusBtn.disabled = isLoading;
        checkAiStatusBtn.disabled = isLoading;
        colorBtn.disabled = isLoading;
        aiSubButton.disabled = isLoading;
        if (isLoading) {
            colorStatus.textContent = text;
            aiStatus.textContent = text;
        }
    }

    function updateAllUIs() {
        renderColorStatus();
        updateAiStatus();
    }

    // --- UI Update Functions ---
    function renderColorStatus() {
      if (passActive && passUntil > Date.now()) {
        const hours = Math.max(0, Math.ceil((passUntil - Date.now())/3600000));
        colorStatus.textContent = `‚úÖ color ACTIVE (~${hours}h left)`;
        colorBtn.disabled = true;
      } else {
        passActive = false;
        colorStatus.textContent = '';
        colorBtn.disabled = false;
      }
      checkStatusBtn.disabled = false;
    }

    function updateAiStatus() {
      const isConnected = !!userPubkey;
      aiConnectWalletBtn.disabled = isConnected;
      aiConnectWalletBtn.textContent = isConnected ? 'Wallet Connected' : 'Connect Wallet';
      checkAiStatusBtn.disabled = false;

      if (!isConnected) {
        aiStatus.textContent = 'connect wallet to begin...';
        aiAskButton.disabled = true;
        aiSubButton.disabled = false;
        return;
      }
      
      if (aiSubActive) {
        const daysLeft = Math.ceil((aiSubUntil - Date.now()) / (1000 * 60 * 60 * 24));
        aiStatus.textContent = `Subscribed! Unlimited questions. (~${daysLeft} days left)`;
        aiSubStatus.textContent = `‚úÖ Subscription active.`;
        aiAskButton.disabled = false;
        aiSubButton.textContent = 'Subscription Active';
        aiSubButton.disabled = true;
      } else {
        const remaining = Math.max(0, AI_FREE_MESSAGE_LIMIT - freeMessagesUsed);
        aiStatus.textContent = `You have ${remaining} free questions remaining.`;
        aiSubStatus.textContent = '';
        aiAskButton.disabled = remaining <= 0;
        aiSubButton.textContent = 'Subscribe for unlimited answers ‚Äî 0.01 SOL / month';
        aiSubButton.disabled = false;
        if (remaining <= 0) {
          aiStatus.textContent = 'Free limit reached. Subscribe for more.';
        }
      }
    }

    // --- Payment & Action Handlers ---
    async function handlePayment(price, confirmationFn, statusElement) {
        const provider = window.solana;
        const MERCHANT = 'DstrKLkb6W6wYfDyDoMBmgDCTwkh2R4RWv6aQasWUj2F';

        if (!provider?.isPhantom) { alert('Phantom wallet is not installed.'); return; }
        if (!window.solanaWeb3) { alert('Solana web3 is not loaded (hard refresh).'); return; }

        try {
            if (!userPubkey) {
                const newKey = await connectWallet();
                if (!newKey) return;
            }

            if ((confirmationFn.name.includes('Ai') && aiSubActive) || (confirmationFn.name.includes('Payment') && passActive)) {
                statusElement.textContent = '‚úÖ Already active!';
                updateAllUIs();
                return;
            }

            statusElement.textContent = 'getting blockhash‚Ä¶';
            const bh = await getBlockhash();
            const { blockhash, lastValidBlockHeight } = bh?.data;
            if (!blockhash || !lastValidBlockHeight) throw new Error('No blockhash from backend');

            statusElement.textContent = 'opening Phantom‚Ä¶';
            const tx = new window.solanaWeb3.Transaction({
                feePayer: new window.solanaWeb3.PublicKey(userPubkey),
                recentBlockhash: blockhash,
            }).add(
                window.solanaWeb3.SystemProgram.transfer({
                    fromPubkey: new window.solanaWeb3.PublicKey(userPubkey),
                    toPubkey: new window.solanaWeb3.PublicKey(MERCHANT),
                    lamports: Math.round(price * 1_000_000_000)
                })
            );

            statusElement.textContent = 'awaiting approval‚Ä¶';
            const { signature } = await provider.signAndSendTransaction(tx);
            
            statusElement.textContent = 'confirming‚Ä¶';
            const { data } = await confirmationFn({ userPubkey, signature, blockhash, lastValidBlockHeight });

            if (data?.ok) {
                await refreshAllStatuses();
            } else {
                throw new Error(data?.reason || 'verification failed');
            }
        } catch (e) {
            console.error('Payment error:', e);
            statusElement.textContent = `‚ùå ${e.message.includes('User rejected') ? 'cancelled' : 'failed'}`;
            updateAllUIs();
        }
    }
    
    async function refreshStatusesFromButton() {
        if (!userPubkey) {
            await connectWallet();
        } else {
            await refreshAllStatuses();
        }
    }

    colorBtn.addEventListener('click', () => handlePayment(0.01, confirmAndVerifyPayment, colorStatus));
    aiSubButton.addEventListener('click', () => handlePayment(0.01, confirmAndVerifyAiSubscription, aiSubStatus));
    checkStatusBtn.addEventListener('click', refreshStatusesFromButton);
    aiConnectWalletBtn.addEventListener('click', connectWallet);
    checkAiStatusBtn.addEventListener('click', refreshStatusesFromButton);

    // --- WhisprBot AI Logic ---
    function addMessageToChat(message, type) {
      const p = document.createElement('p');
      p.textContent = message;
      p.className = type;
      aiChatHistory.appendChild(p);
      aiChatHistory.scrollTop = aiChatHistory.scrollHeight;
    }

    async function askBot() {
      if (!userPubkey) {
          const newKey = await connectWallet();
          if (!newKey) return;
      }
      const question = aiQuestionInput.value.trim();
      if (!question || aiAskButton.disabled) return;
      addMessageToChat(`> ${question}`, 'user-q');
      aiQuestionInput.value = '';
      aiAskButton.disabled = true;
      aiStatus.textContent = 'thinking...';
      try {
        const { data } = await askWhisprBotFn({ question, userPubkey });
        if (data.ok) {
          addMessageToChat(data.answer, 'bot-a');
          if (!aiSubActive) freeMessagesUsed++;
        } else {
          addMessageToChat(`... ${data.reason || 'an error occurred'} ...`, 'bot-a');
        }
      } catch (e) {
        console.error('[whispr] askBot error:', e);
        addMessageToChat(`... ${e.message || 'the static is too loud...'}`, 'bot-a');
      } finally {
        updateAiStatus();
      }
    }
    
    addMessageToChat('...i am listening...', 'bot-a');
    aiAskButton.addEventListener('click', askBot);
    aiQuestionInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); askBot(); } });

    // --- Whisper Sending & Display Logic ---
    function floatWhisper(text, strong, colored = false, delay = 0){
      const s = document.createElement('span');
      s.textContent = text;
      s.style.top  = (10 + Math.random()*80) + '%';
      s.style.left = (5 + Math.random()*90) + '%';
      s.style.color = colored ? '#a8ffa8' : (strong ? 'rgba(255,255,255,0.55)' : 'rgba(255,255,255,0.35)');
      s.style.textShadow = `0 0 10px ${colored ? '#a8ffa8' : 'rgba(255,255,255,0.1)'}`;
      s.style.fontSize = (18 + Math.floor(Math.random()*6)) + 'px';
      s.style.animationDelay = `${delay}s`;
      s.style.animationDuration = (15 + Math.random() * 10) + 's'; // Varijabilno trajanje
      whispersLayer.appendChild(s);
    }

    async function sendWhisper(){
      const text = (whisperInput.value || '').trim();
      if (!text) return;

      if (profanityFilter.isProfane(text)) {
          whisperStatus.textContent = '‚ùå inappropriate language';
          whisperStatus.classList.add('show');
          setTimeout(() => { whisperStatus.classList.remove('show'); whisperStatus.textContent = ''; }, 2500);
          return;
      }

      whisperInput.disabled = true;
      whisperSendBtn.disabled = true;
      whisperStatus.textContent = 'sending...';
      whisperStatus.classList.add('show');

      try {
        const { data } = await sendWhisperFn({ text, userPubkey });
        if (data.ok) {
          whisperStatus.textContent = 'sent.';
          // Ne moramo ruƒçno crtati, `child_added` ƒáe to odraditi
        } else {
          whisperStatus.textContent = `‚ùå ${data.reason || 'Could not send'}`;
        }
      } catch (e) {
        whisperStatus.textContent = '‚ùå error sending.';
      }

      whisperInput.value = '';
      setTimeout(() => {
        whisperInput.disabled = false;
        whisperSendBtn.disabled = false;
        whisperStatus.classList.remove('show');
        whisperStatus.textContent = '';
      }, 2000);
    }
    
    whisperSendBtn.addEventListener('click', sendWhisper);
    whisperInput.addEventListener('keydown', e => { if (e.key === 'Enter'){ e.preventDefault(); sendWhisper(); } });
  
    // --- Live Feed, Initial Load, Cleanup & Trending ---
    const twentyFourHoursAgo = () => Date.now() - (24 * 60 * 60 * 1000);

    // 1. Uƒçitaj postojeƒáe poruke pri otvaranju stranice
    async function loadInitialWhispers() {
        try {
            const snap = await db.ref('whispers').orderByChild('time').startAt(twentyFourHoursAgo()).once('value');
            const data = snap.val();
            if (!data) return;
            
            whispersLayer.innerHTML = ''; // Oƒçisti stare (hardkodirane)
            Object.values(data).forEach((item, index) => {
                // Dodajemo mali delay da ne krenu sve odjednom
                floatWhisper(item.text, false, !!item.colored, Math.random() * 15);
            });
            console.log(`[whispr] Loaded ${Object.keys(data).length} initial whispers.`);
        } catch (e) {
            console.error('[whispr] Initial load error:', e);
        }
    }

    // 2. Slu≈°aj za nove poruke
    db.ref('whispers').orderByChild('time').startAt(Date.now()).on('child_added', snap => {
      const item = snap.val();
      if (!item || !item.text) return;
      floatWhisper(item.text, false, !!item.colored);
    });

    // 3. Logika za trending listu
    async function updateTrendingWhispers() {
      try {
        const snap = await db.ref('whispers').orderByChild('time').startAt(twentyFourHoursAgo()).once('value');
        const data = snap.val();
        if (!data) {
          trendingContainer.classList.remove('show');
          return;
        }

        const counts = {};
        Object.values(data).forEach(whisper => {
          if (whisper.text) {
            const text = whisper.text.toLowerCase().trim();
            counts[text] = (counts[text] || 0) + 1;
          }
        });

        const sorted = Object.entries(counts).sort(([,a],[,b]) => b - a);
        const top3 = sorted.slice(0, 3);

        if (top3.length > 0) {
          trendingList.innerHTML = top3.map(([text]) => `<li>${text}</li>`).join('');
          trendingContainer.classList.add('show');
        } else {
          trendingContainer.classList.remove('show');
        }
      } catch (e) {
        console.error('[whispr] trending update error:', e);
      }
    }

    // 4. Periodiƒçno ƒçi≈°ƒáenje starih poruka
    setInterval(async () => {
      try {
        const oldWhispersRef = db.ref('whispers').orderByChild('time').endAt(twentyFourHoursAgo());
        const snap = await oldWhispersRef.once('value');
        const data = snap.val();
        if (!data) return;

        const updates = {};
        Object.keys(data).forEach(key => { updates[key] = null; });
        db.ref('whispers').update(updates);
        console.log(`[whispr] auto-clean done, removed ${Object.keys(data).length} whispers.`);
      } catch (e) { console.error('[whispr] auto-clean error:', e); }
    }, 3600000); // Svakih sat vremena

    // --- Inicijalizacija ---
    updateAllUIs();
    loadInitialWhispers();
    updateTrendingWhispers();
    setInterval(updateTrendingWhispers, 30000); // Osvje≈æi trending svakih 30 sekundi

    db.ref('connection-test').set({ok:true, t:Date.now()})
      .then(()=>console.log('[whispr] test write OK'))
      .catch(err=>console.error('[whispr] test write FAIL', err));
  });
})();
</script>
</body>
</html>

























































































































