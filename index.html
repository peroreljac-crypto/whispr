<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="whispr.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>whispr</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

   body {
  margin: 0;
  height: 100vh;
  background: url('https://raw.githubusercontent.com/whisprcoin/whispr/refs/heads/main/5.png') no-repeat center center fixed;
  background-size: cover;
  color: #fff;
  font-family: 'VT323', monospace;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  letter-spacing: 1px;
  backdrop-filter: brightness(0.7) blur(1px);
}
    
    h1 {
      font-size: 80px;
      margin-bottom: 10px;
    }

    p {
      color: #9c9c9c;
      font-size: 24px;
      margin: 3px;
    }

    small {
      color: #707070;
      font-size: 18px;
      margin-top: 25px;
    }

    .matrix-lines {
      position: fixed;
      width: 100%;
      height: 100%;
      background-image: repeating-linear-gradient(
        90deg,
        rgba(255, 255, 255, 0.02) 0px,
        rgba(255, 255, 255, 0.02) 1px,
        transparent 2px,
        transparent 4px
      );
      pointer-events: none;
      z-index: 0;
    }

    .content {
      position: relative;
      z-index: 1;
    }

    a {
      color: #9c9c9c;
      text-decoration: none;
      font-size: 20px;
      margin: 8px;
    }

    a:hover {
      color: #ffffff;
    }
    .footer-links {
  position: fixed;
  bottom: 25px;
  left: 0;
  width: 100%;
  text-align: center;
  z-index: 2;
}

.footer-links a {
  color: #9c9c9c;
  text-decoration: none;
  font-size: 20px;
  margin: 0 15px;
}

.footer-links a:hover {
  color: #ffffff;
}
    .whispers {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  pointer-events: none;
  z-index: 0;
}

.whispers span {
  position: absolute;
  color: rgba(255, 255, 255, 0.25); /* üî• jaƒça vidljivost */
  font-size: 20px; /* malo veƒái font */
  font-family: 'VT323', monospace;
  text-shadow: 0 0 6px rgba(255, 255, 255, 0.1); /* lagani sjaj */
  animation: whisperMove 15s linear infinite;
  opacity: 0;
}

@keyframes whisperMove {
  0% { opacity: 0; transform: translateY(0); }
  10% { opacity: 0.4; }
  50% { opacity: 0.2; transform: translateY(-40px); }
  90% { opacity: 0; }
  100% { opacity: 0; transform: translateY(-80px); }
}
    /* ghost "shhh..." */
.shhh-ghost{
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: rgba(255,255,255,0.28);
  font-family: 'VT323', monospace;
  font-size: 32px;                 /* pojaƒçaj/smanji po ≈æelji */
  letter-spacing: 1px;
  opacity: 0;
  pointer-events: none;
  z-index: 6;                      /* iznad pozadine i whispers teksta */
  text-shadow: 0 0 6px rgba(255,255,255,0.10);
  transition: opacity 0.6s ease;
}
.shhh-ghost.show{ opacity: 1; }
    .content {
  position: relative;
  z-index: 5;
}
      .whisper-box{
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  margin-top: 25px;
  margin-bottom: 25px;
  width: 100%;
}
}

#whisperInput{
  width: min(800px, 90vw);
  padding: 10px 12px;
  border: 1px solid #2a2a2a;
  background: rgba(12,12,12,.8);
  color: #eaeaea;
  font-family: 'VT323', monospace;
  font-size: 18px;
  outline: none;
  border-radius: 6px;
  transition: border-color .2s ease, background .2s ease;
}
#whisperInput::placeholder{ color:#6f6f6f; }
    #whisperInput{
  color: white;
}
#whisperInput:focus{
  border-color:#555;
  background: rgba(18,18,18,.9);
}

#whisperSend{
  padding: 10px 14px;
  border: 1px solid #2a2a2a;
  background: rgba(18,18,18,.85);
  color:#cfcfcf;
  font-family: 'VT323', monospace;
  font-size:18px;
  border-radius:6px;
  cursor:pointer;
  transition: transform .08s ease, background .2s ease, color .2s;
}
#whisperSend:hover{ background:#1b1b1b; color:#fff; }
#whisperSend:active{ transform: translateY(1px); }

.whisper-note{
  width: 100%;
  text-align: center;
  font-size: 14px;
  color:#6f6f6f;
  margin-top: 6px;
  opacity:.8;
}

.whisper-status{
  width:100%;
  text-align:center;
  font-size:16px;
  color:#a8ffa8;
  margin-top:8px;
  min-height: 1em; /* da ne ‚Äúskaƒçe‚Äù layout */
  visibility: hidden;
}
.whisper-status.show{ visibility: visible; }

/* osiguraj da je content iznad pozadine/whispers slojeva */
.content{ position: relative; z-index: 5; }
    .user-whisper {
  color: rgba(255, 255, 255, 0.65) !important; /* jaƒçe vidljiv */
  text-shadow: 0 0 8px rgba(255,255,255,0.15);
  font-size: 22px !important;
  letter-spacing: 1px;
}
    .content small {
  display: block;
  margin-top: 10px;
  font-size: 18px;
  color: rgba(255,255,255,0.65);
}

.whisper-box {
  margin-top: 25px;   /* razmak ispod teksta */
  margin-bottom: 25px; /* prije footera */
}
    .whispers {
  pointer-events: none;
  z-index: 0;
  position: fixed;
  inset: 0;
}

.content {
  position: relative;
  z-index: 5;
}
    .wallet-row{
  margin-top:10px;
  display:flex; gap:10px; align-items:center; justify-content:center;
  opacity:.9;
}
#walletStatus{ color:#9c9c9c; font-size:14px; }

.admin-bar{
  margin-top:10px;
  display:flex; gap:10px; align-items:center; justify-content:center;
  font-size:14px; color:#bbb;
}
#toggleMode{
  padding:6px 10px; font-family:'VT323', monospace;
  border:1px solid #2a2a2a; background:#0b0b0b; color:#fff; border-radius:6px;
}

/* zakljuƒçan UI */
#whisperInput[disabled]{ opacity:.6; cursor:not-allowed; }
#whisperSend[disabled]{ opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body>
  <div class="matrix-lines"></div>
   <div class="whispers">
    <span>it started again.</span>
    <span>can you hear it?</span>
    <span>they woke it up.</span>
    <span>not again...</span>
    <span>silence speaks first.</span>
  </div>
  <div class="live-whispers"></div>
  <div class="content">
    <h1>whispr</h1>
    
    <small>the value is in silence. üîá</small>
    <div class="whisper-box">
  <input id="whisperInput" type="text" maxlength="140"
         placeholder="send a whispr.">
  <button id="whisperSend" aria-label="send whisper">send üîá</button>
  <div class="whisper-note" aria-hidden="true">anonymous ¬∑ not saved</div>
  <div id="whisperStatus" class="whisper-status" aria-live="polite"></div>
</div>
    <div class="wallet-row">
  <button id="connectPhantom" type="button">connect phantom</button>
  <span id="walletStatus">not connected</span>
</div>

<div id="adminBar" class="admin-bar" style="display:none">
  <span>mode:</span>
  <button id="toggleMode" type="button">free</button>
  <small id="modeHint">(holders-only is OFF)</small>
</div>
    <div class="footer-links">
  <a href="https://x.com/whisprcoin" target="_blank">x</a>
  <a href="#" target="_blank">solscan (soon)</a>
</div>
  </div>
  <script>
  const whispers = document.querySelectorAll('.whispers span');
  function randomizeWhispers() {
    whispers.forEach(w => {
      w.style.top = Math.random() * 100 + '%';
      w.style.left = Math.random() * 100 + '%';
      w.style.animationDelay = (Math.random() * 10) + 's';
    });
  }
  randomizeWhispers();
  setInterval(randomizeWhispers, 15000);
</script>
   <script>
  // kreira i prika≈æe "shhh..." pa ga makne
  function spawnShhh(){
    // makni postojeƒái ako veƒá traje (sprijeƒçi spam)
    const old = document.querySelector('.shhh-ghost');
    if (old) old.remove();

    const s = document.createElement('div');
    s.className = 'shhh-ghost';
    s.textContent = 'shhh...';
    document.body.appendChild(s);

    // fade in
    requestAnimationFrame(() => s.classList.add('show'));

    // nakon 1.4s poƒçni gasiti, pa ukloni
    setTimeout(() => {
      s.classList.remove('show');
      setTimeout(() => s.remove(), 600);
    }, 1400);
  }

  // ciljaj H1 unutar .content (tvoj "whispr")
  const titleEl = document.querySelector('.content h1');

  if (titleEl){
    // hover na desktopu
    titleEl.addEventListener('mouseenter', spawnShhh);
    // tap na mobitelu
    titleEl.addEventListener('touchstart', spawnShhh, {passive:true});
  }
</script>
<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>

<script>
(function(){
  console.log('[whispr] boot');

  // 1) Init kad se sve uƒçita (da elementi postoje)
  window.addEventListener('load', function(){
    console.log('[whispr] dom ready');

    // 2) Firebase config
    const cfg = {
      apiKey: "AIzaSyD1R-5ltVcfW8PiuoJ4d7Kt2kouIS0M4Do",
      authDomain: "whisprcoin.firebaseapp.com",
      databaseURL: "https://whisprcoin-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "whisprcoin",
      storageBucket: "whisprcoin.firebasestorage.app",
      messagingSenderId: "1063673504189",
      appId: "1:1063673504189:web:938b00b8a6871b0a5db2d4",
      measurementId: "G-ZYWYEXVG4F"
    };

    if (!window.firebase) { console.error('[whispr] Firebase SDK nije uƒçitan'); return; }
    if (!firebase.apps.length) { firebase.initializeApp(cfg); console.log('[whispr] firebase init OK'); }
    const db = firebase.database();

    // 3) DOM elementi
    const layer  = document.querySelector('.whispers');
    const input  = document.getElementById('whisperInput');
    const button = document.getElementById('whisperSend');
    const status = document.getElementById('whisperStatus');

    console.log('[whispr] elements:', {layer: !!layer, input: !!input, button: !!button});

    if (!input || !button) {
      console.error('[whispr] MISSING #whisperInput ili #whisperSend u HTML-u');
      return;
    }

    // 4) Helper za nacrtati lebdeƒái whisper
    function floatWhisper(text, strong){
      if (!layer) return;
      const s = document.createElement('span');
      s.textContent = text;
      s.style.position = 'absolute';
      s.style.top  = (10 + Math.random()*80) + '%';
      s.style.left = (5 + Math.random()*90) + '%';
      s.style.color = strong ? 'rgba(255,255,255,0.55)' : 'rgba(255,255,255,0.35)';
      s.style.fontSize = (18 + Math.floor(Math.random()*6)) + 'px';
      s.style.textShadow = strong ? '0 0 10px rgba(255,255,255,0.28)' : '0 0 6px rgba(255,255,255,0.1)';
      s.style.animation = 'whisperMove 12s linear 1';
      s.style.opacity = '0';
      layer.appendChild(s);
      setTimeout(()=>s.remove(), 12000);
    }

    // 5) Slanje u bazu
    async function sendWhisper(){
      const text = (input.value || '').trim();
      if (!text) return;
      console.log('[whispr] sending:', text);

      // instant feedback
      floatWhisper(text, true);

      try {
        await db.ref('whispers').push({ text, time: Date.now() });
        console.log('[whispr] saved');
        if (status){ status.textContent = 'sent.'; setTimeout(()=>status.textContent='', 1500); }
      } catch(e){
        console.error('[whispr] save ERROR', e);
        if (status){ status.textContent = 'error.'; setTimeout(()=>status.textContent='', 2000); }
      }

      input.value = '';
    }
    // üßπ AUTO-CLEAN svakih 20 sekundi
setInterval(async () => {
  try {
    const snap = await db.ref('whispers').once('value');
    const data = snap.val();
    if (!data) return;

    const now = Date.now();
    const cutoff = now - 20000; // 20 sekundi

    Object.entries(data).forEach(([key, val]) => {
      if (val.time < cutoff) {
        db.ref('whispers/' + key).remove();
      }
    });

    console.log('[whispr] auto-clean done');
  } catch (e) {
    console.error('[whispr] auto-clean error:', e);
  }
}, 20000); // pokreƒáe se svakih 20 sekundi
/* ====== SOLANA GATE: FREE ‚Üí HOLDERS-ONLY (koristi tvoje varijable) ====== */

/** KOLIKO TREBA DR≈ΩATI */
const WHISPR_MIN_AMOUNT = 1;

/** SPL MINT ADRESA ‚Äî zamijeni ƒçim izda≈° token */
const WHISPR_MINT = '3GArCrYyJDxtc99RMZcDQkEaX7EpSks8cYF2smC4';

/** oslonimo se na postojeƒái db; ako ga nema, probaj iz firebase-a */
const DB = (typeof db !== 'undefined') ? db : (firebase && firebase.database ? firebase.database() : null);
if (!DB) { console.error('[whispr] DB not ready'); }

/** globalno stanje */
let requireOwnership = false; // dok je false ‚Üí FREE
let walletPubkey = null;
let lastHolderOk = false;

/** elementi (koristimo tvoje postojeƒáe) */
const connectBtn  = document.getElementById('connectPhantom');
const walletLabel = document.getElementById('walletStatus');
const adminBar    = document.getElementById('adminBar');
const toggleMode  = document.getElementById('toggleMode');
const modeHint    = document.getElementById('modeHint');

/** tvoje postojeƒáe varijable: */
const inputEl  = (typeof input  !== 'undefined')  ? input  : document.getElementById('whisperInput');
const statusEl = (typeof status !== 'undefined') ? status : document.getElementById('whisperStatus');

/** prika≈æi admin bar samo s ?admin=1 */
const isAdmin = location.search.includes('admin=1');
if (isAdmin && adminBar) adminBar.style.display = 'flex';

/** CONFIG toggle u Firebaseu: /config/requireOwnership (true/false) */
const cfgRef = DB.ref('config/requireOwnership');

/** ako ne postoji, postavi default (FREE) */
cfgRef.once('value').then(s => { if (s.val() === null) cfgRef.set(false); });

/** slu≈°aj promjene moda globalno */
cfgRef.on('value', snap => {
  requireOwnership = !!snap.val();
  updateModeUI();
  updateGateUI();
});
   /* 1) Forsiraj HTTPS (osim localhosta) */
(() => {
  const isLocal = ['localhost', '127.0.0.1'].includes(location.hostname);
  if (!isLocal && location.protocol !== 'https:') {
    location.replace('https://' + location.host + location.pathname + location.search + location.hash);
  }
})();

/* 2) Provjeri da gumb nije submit (da ne reloada stranicu) */
const _btnConnect = document.getElementById('connectPhantom');
if (_btnConnect) _btnConnect.setAttribute('type', 'button');

/* 3) Ako si imao neki STARI handler za connect ‚Äî makni ga (klon trik) */
if (_btnConnect) {
  const clone = _btnConnect.cloneNode(true);
  _btnConnect.replaceWith(clone);
}

/* 4) Uvijek izaberi ba≈° Phantom providera (ako ih ima vi≈°e) */
function getPhantom() {
  const w = window;
  if (w.solana?.isPhantom) return w.solana;
  if (Array.isArray(w.solana?.providers)) {
    const p = w.solana.providers.find(p => p.isPhantom);
    if (p) return p;
  }
  return null;
}

/* 5) UI helper */
function setWalletLabel(pkStr) {
  const label = document.getElementById('walletStatus');
  if (label) label.textContent = pkStr || '(not connected)';
}

/* 6) Eventi + klik handler */
(function initPhantomConnect() {
  const btn = document.getElementById('connectPhantom');
  if (!btn) return;

  const provider = getPhantom();

  // Eventi (ako postoje)
  provider?.on?.('connect', (pk) => setWalletLabel(pk?.toBase58?.?.() || pk?.toString?.()));
+ provider?.on?.('accountChanged', (pk) => setWalletLabel(pk ? (pk.toBase58?.() || pk.toString()) : '(disconnected)'));

  // Glavni click ‚Äî reset pa connect
  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    const prov = getPhantom();
    if (!prov) {
      alert('Phantom extension nije detektiran.\n- Iskljuƒçi adblock/shields\n- Ne koristi iFrame/preview\n- Otvori https://www.whisprcoin.com');
      return;
    }
    try {
      try { await prov.disconnect(); } catch(_) {}   // oƒçisti pending stanje
      const res = await prov.connect({ onlyIfTrusted: false });
      const pk = prov.publicKey ?? res?.publicKey;
      setWalletLabel(pk?.toString?.() || '(no key)');
      renderWalletUI(pk?.toString?.());   
      console.log('[PHANTOM] connected:', pk?.toString?.());
    } catch (err) {
      console.error('[PHANTOM] connect error:', err);
      alert('Phantom connect error: ' + (err?.message || err));
    }
  });

  // Ako je veƒá spojen nakon refresh-a
  if (provider?.isConnected && provider?.publicKey) {
    setWalletLabel(provider.publicKey.toString());
  } else {
    setWalletLabel('(not connected)');
  }
})();
    
/** üîπ KRAJ PHANTOM CONNECTA üîπ */

    /** üîπ LJEP≈†I PHANTOM UI üîπ */
function shorten(pk){ 
  return pk ? pk.slice(0,4) + '‚Ä¶' + pk.slice(-4) : ''; 
}

async function copyToClipboard(text){ 
  try { 
    await navigator.clipboard.writeText(text); 
    alert('Address copied'); 
  } catch(e){ console.error(e); } 
}

function renderWalletUI(pkStr){
  const btn   = document.getElementById('connectPhantom');
  const label = document.getElementById('walletStatus');
  if (!btn) return;

  if (pkStr){
    // prikaz nakon connecta
    btn.textContent = 'Connected';
    if (label){
      label.innerHTML = `
        <span id="addrShort" style="font-family:monospace">${shorten(pkStr)}</span>
        <button id="copyPk" type="button" style="margin-left:8px">Copy</button>
        <button id="disconnectPk" type="button" style="margin-left:4px">Disconnect</button>`;
    }

    // gumbi
    document.getElementById('copyPk')?.addEventListener('click', ()=>copyToClipboard(pkStr));
    document.getElementById('disconnectPk')?.addEventListener('click', async ()=>{
      try { await window.solana?.disconnect?.(); } catch(e){}
      renderWalletUI(null);
      // opcionalno: zakljuƒçaj whisper input
      if (typeof setWhisperGate === 'function') setWhisperGate(false);
    });
  } else {
    // reset UI kad se odspoji
    btn.textContent = 'Connect Phantom';
    if (label) label.textContent = '(not connected)';
  }
}

/** UI helpers */
function updateModeUI(){
  if (!toggleMode || !modeHint) return;
  toggleMode.textContent = requireOwnership ? 'holders-only' : 'free';
  modeHint.textContent   = requireOwnership ? '(holders-only is ON)' : '(holders-only is OFF)';
}
function updateGateUI(){
  if (!inputEl || !whisperSend) return;
  if (!requireOwnership){
    inputEl.disabled = false; whisperSend.disabled = false;
    if (inputEl.placeholder.toLowerCase().includes('connect wallet')){
      inputEl.placeholder = 'send a whispr.';
    }
  } else {
    if (lastHolderOk){
      inputEl.disabled = false; whisperSend.disabled = false;
    } else {
      inputEl.disabled = true;  whisperSend.disabled = true;
      inputEl.placeholder = 'connect wallet to whisper.';
    }
  }
}

/** Phantom connect */
async function connectPhantom(){
  if (!window.solana || !window.solana.isPhantom){
    alert('Install Phantom wallet to continue.');
    return null;
  }
  try{
    const resp = await window.solana.connect();
    walletPubkey = resp.publicKey.toBase58();
    if (walletLabel) walletLabel.textContent = walletPubkey.slice(0,4)+'‚Ä¶'+walletPubkey.slice(-4);

    if (requireOwnership){
      lastHolderOk = await hasWhispr(walletPubkey, WHISPR_MINT, WHISPR_MIN_AMOUNT);
      updateGateUI();
    }
    return walletPubkey;
  }catch(e){
    console.warn('phantom connect cancelled', e?.message);
    return null;
  }
}

/** SPL balance provjera (RPC) */
async function hasWhispr(owner, mintAddress, minAmount){
  try{
    const rpc = 'https://api.mainnet-beta.solana.com'; // devnet: 'https://api.devnet.solana.com'
    const body = {
      jsonrpc:"2.0", id:1, method:"getTokenAccountsByOwner",
      params:[ owner, { mint: mintAddress }, { encoding:"jsonParsed" } ]
    };
    const res = await fetch(rpc, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    }).then(r=>r.json());
    const accounts = res?.result?.value || [];
    let balance = 0;
    for (const a of accounts){
      const ui = a?.account?.data?.parsed?.info?.tokenAmount?.uiAmount;
      if (typeof ui === 'number') balance += ui;
    }
    return balance >= minAmount;
  }catch(e){
    console.error('balance check error', e);
    return false;
  }
}

/** admin toggle ‚Äî pi≈°e u Firebase (simple pass, promijeni kad ≈æeli≈°) */
if (isAdmin && toggleMode){
  toggleMode.addEventListener('click', async () => {
    const pass = prompt('admin pass (privremeno):');
    if (pass !== 'whispr-admin') return alert('nope.');
    await cfgRef.set(!requireOwnership);
  });
}

/** connect phantom gumb */
if (connectBtn){
  connectBtn.addEventListener('click', async () => { await connectPhantom(); });
}

/** ‚õî Zamjena tvoje sendWhisper logike: ubacujemo gate na VRH pa zovemo tvoju istu funkciju */
const __originalSendWhisper = sendWhisper; // spremi tvoju postojeƒáu

window.sendWhisper = async function(){
  // HOLDERS-ONLY gate
  if (requireOwnership){
    if (!walletPubkey){
      await connectPhantom();
      if (!walletPubkey) return; // user odustao
    }
    lastHolderOk = await hasWhispr(walletPubkey, WHISPR_MINT, WHISPR_MIN_AMOUNT);
    if (!lastHolderOk){
      if (statusEl){ statusEl.textContent = 'need 1 $WHISPR to whisper'; setTimeout(()=>statusEl.textContent='', 2000); }
      updateGateUI();
      return;
    }
  }
  // sve ok ‚Üí pozovi tvoju originalnu funkciju (ne diramo floatWhisper, db, itd.)
  return __originalSendWhisper();
};

// inicijalni UI
updateModeUI();
updateGateUI();

/* ====== /SOLANA GATE ====== */
   <script>
/* ==== PHANTOM CONNECT ‚Äî JEDINI IZVOR ISTINE ==== */
function getPhantom() {
  const w = window;
  if (w.solana?.isPhantom) return w.solana;
  if (Array.isArray(w.solana?.providers)) {
    const p = w.solana.providers.find(p => p.isPhantom);
    if (p) return p;
  }
  return null;
}

window.walletPubkey = window.walletPubkey || null;

function setWalletLabel(pkStr) {
  const label = document.getElementById('walletStatus');
  if (label) label.textContent = pkStr || '(not connected)';
}

function afterConnect(provider){
  try {
    const pk = provider?.publicKey?.toBase58?.() || provider?.publicKey?.toString?.() || '';
    window.walletPubkey = pk || null;
    setWalletLabel(pk || '(connected)');
    renderWalletUI(pk);
    if (typeof startOwnersListener === 'function' && pk) startOwnersListener(pk);
    if (typeof updateGateUI === 'function') updateGateUI();
  } catch (e) {
    console.warn('afterConnect error', e);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('connectPhantom');
  if (!btn) return;

  btn.setAttribute('type', 'button');
  const provider = getPhantom();

  provider?.on?.('accountChanged', (pkObj) => {
    const pk = pkObj ? (pkObj.toBase58?.() || pkObj.toString?.() || '') : '';
    window.walletPubkey = pk || null;
    setWalletLabel(pk || '(disconnected)');
    renderWalletUI(pk || null);
    if (typeof setWhisperGate === 'function') setWhisperGate(!!pk);
    if (typeof updateGateUI === 'function') updateGateUI();
    if (pk && typeof startOwnersListener === 'function') startOwnersListener(pk);
  });

  if (provider?.isConnected && provider?.publicKey) {
    afterConnect(provider);
  } else {
    setWalletLabel('(not connected)');
  }

  btn.onclick = async (e) => {
    e.preventDefault();
    const prov = getPhantom();
    if (!prov) {
      alert('Phantom nije detektiran. Iskljuƒçi adblock/shields i otvori site izvan iFrame-a (https://whisprcoin.com).');
      return;
    }
    try {
      try { await prov.disconnect(); } catch(_) {}
      await prov.connect({ onlyIfTrusted: false });
      afterConnect(prov);
    } catch (err) {
      console.error('Phantom connect error:', err);
      alert('Gre≈°ka pri povezivanju: ' + (err?.message || err));
    }
  };
});
/* ==== /PHANTOM CONNECT ==== */
</script>
  <!-- verifyOwnership + listener -->
<script>
/* ---------- WHISPR: UI + verify helper (REPLACE ovaj block) ---------- */

/* ‚úÖ KONSTANTE */
const VERIFY_FUNCTION_URL = 'https://verifyownership-chmwowrmka-uc.a.run.app';
const WHISPR_MINT = '3GArCrYyJDxtc99RMZcDQkEaX7EpSks8cYF2smC4'; // ƒåIST base58

/* ‚úÖ Base58 helperi (ƒçiste pasteane vrijednosti) */
function cleanBase58(s=""){ return String(s).trim().replace(/[^1-9A-HJ-NP-Za-km-z]/g,''); }
function isBase58(s=""){ return /^[1-9A-HJ-NP-Za-km-z]+$/.test(s); }

/* ‚úÖ Uvijek izvuci Phantom key kao base58 (ne oslanjaj se na .toString()) */
function getPkBase58() {
  const pkObj = window.solana?.publicKey;
  try { return pkObj?.toBase58?.() || pkObj?.toString?.() || ""; } catch { return ""; }
}

/* ‚úÖ Poziv verify endpointa ‚Äì sad ≈°aljemo i MINT */
async function callVerify(pubkey, txSig) {
  const payload = { pubkey, txSig, mint: WHISPR_MINT };
  // debug u konzolu da odmah vidi≈° duljine
  console.log('[verify payload]', {
    pubkey, pubkey_len: pubkey?.length || 0,
    txSig_len: txSig?.length || 0,
    mint_len: WHISPR_MINT.length
  });
  try {
    const res = await fetch(VERIFY_FUNCTION_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    return await res.json();
  } catch (e) {
    console.error('callVerify error', e);
    return { ok:false, err: String(e) };
  }
}

/* UI helpers (ostavi ove, koristi tvoje elemente ako postoje) */
function setWalletLabel(text){
  const label = document.getElementById('walletStatus') || document.getElementById('walletLabel');
  if (label) label.textContent = text;
}
function setWhisperGate(open){
  const sendBtn = document.getElementById('sendWhisper') || document.querySelector('.send-whisper-btn');
  if (sendBtn) sendBtn.disabled = !open;
}

/* ‚úÖ Manual verify gumb ‚Äì sad ƒçisti i validira base58 */
function ensureManualVerifyButton(){
  if (document.getElementById('manualVerifyBtn')) return;
  const connectBtn = document.getElementById('connectPhantom') || null;
  const b = document.createElement('button');
  b.id = 'manualVerifyBtn';
  b.textContent = 'Manual verify txSig';
  b.style.cssText = 'margin-left:8px;padding:6px;';
  b.addEventListener('click', async () => {
    let pk = getPkBase58();
    pk = cleanBase58(pk);
    if (!pk || !isBase58(pk)) return alert('Nema valjanog wallet-a (pubkey). Pove≈æi Phantom.');

    const txRaw = prompt('Paste tx signature (txSig) here:');
    if (!txRaw) return;
    const txSig = cleanBase58(txRaw);
    if (!isBase58(txSig)) return alert('Nevaljan txSig (mora biti base58).');

    b.disabled = true;
    const r = await callVerify(pk, txSig);
    b.disabled = false;
    alert(JSON.stringify(r));
    // Ako backend upi≈°e owners/<pk>=true, listener ispod ƒáe otkljuƒçati gumb
  });
  if (connectBtn && connectBtn.parentNode) connectBtn.parentNode.insertBefore(b, connectBtn.nextSibling);
  else document.body.appendChild(b);
}

/* ‚úÖ Slu≈°aj owners/<pubkey> i otkljuƒçaj UI kad server potvrdi */
function startOwnersListener(pubkey){
  if (!pubkey || !window.firebase?.database) {
    console.warn('startOwnersListener missing firebase or pubkey');
    return;
  }
  try { if (window.__ownersListenerRef) window.__ownersListenerRef.off(); } catch(e){}
  const ref = firebase.database().ref('owners/' + pubkey);
  window.__ownersListenerRef = ref;
  ref.on('value', snap => {
    const val = snap.val();
    console.log('[owners]', pubkey, val);
    setWhisperGate(!!val);
    if (val) setWalletLabel((pubkey || '(connected)') + ' ‚Äî unlocked');
  });
}

/* ‚úÖ Nakon connecta ‚Äì koristi base58 */
async function handleAfterConnect(){
  ensureManualVerifyButton();
  const pk = cleanBase58(getPkBase58());
  if (pk && isBase58(pk)) {
    setWalletLabel(pk);
    startOwnersListener(pk);
  } else {
    setWalletLabel('(not connected)');
  }
}

/* ‚úÖ Hookovi Phantom eventova + fallback na connect gumb */
document.addEventListener('DOMContentLoaded', () => {
  ensureManualVerifyButton();

  if (window.solana?.isPhantom && window.solana?.isConnected) {
    handleAfterConnect();
  }

  try {
    window.solana?.on?.('connect', pkObj => {
      const pk = cleanBase58(pkObj?.toBase58?.() || pkObj?.toString?.() || "");
      setWalletLabel(pk || '(connected)');
      if (pk) startOwnersListener(pk);
    });
    window.solana?.on?.('disconnect', () => {
      setWalletLabel('(not connected)');
      setWhisperGate(false);
    });
  } catch(e){ console.warn(e); }

  const connectBtn = document.getElementById('connectPhantom');
  if (connectBtn) {
    connectBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      try {
        if (!window.solana?.isPhantom) return alert('Phantom extension nije detektiran. Otvori Phantom extension i probaj ponovno.');
        await window.solana.connect({ onlyIfTrusted: false });
        // connect event ƒáe triggat gore i pokrenuti handleAfterConnect ‚Üí owners listener
      } catch (err) {
        console.error('connect error', err);
        alert('Gre≈°ka pri povezivanju: ' + (err?.message || err));
      }
    });
  }
});
/* ---------- END WHISPR UI ---------- */
</script>
<!-- end verifyOwnership + listener -->
</body>

</html>












































