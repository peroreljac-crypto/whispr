<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="whispr.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>whispr</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

   body {
  margin: 0;
  height: 100vh;
  background: url('https://raw.githubusercontent.com/whisprcoin/whispr/refs/heads/main/5.png') no-repeat center center fixed;
  background-size: cover;
  color: #fff;
  font-family: 'VT323', monospace;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  letter-spacing: 1px;
  backdrop-filter: brightness(0.7) blur(1px);
}
    
    h1 {
      font-size: 80px;
      margin-bottom: 10px;
    }

    p {
      color: #9c9c9c;
      font-size: 24px;
      margin: 3px;
    }

    small {
      color: #707070;
      font-size: 18px;
      margin-top: 25px;
    }

    .matrix-lines {
      position: fixed;
      width: 100%;
      height: 100%;
      background-image: repeating-linear-gradient(
        90deg,
        rgba(255, 255, 255, 0.02) 0px,
        rgba(255, 255, 255, 0.02) 1px,
        transparent 2px,
        transparent 4px
      );
      pointer-events: none;
      z-index: 0;
    }

    .content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    a {
      color: #9c9c9c;
      text-decoration: none;
      font-size: 20px;
      margin: 8px;
    }

    a:hover {
      color: #ffffff;
    }
    .footer-links {
  position: fixed;
  bottom: 25px;
  left: 0;
  width: 100%;
  text-align: center;
  z-index: 2;
}

.footer-links a {
  color: #9c9c9c;
  text-decoration: none;
  font-size: 20px;
  margin: 0 15px;
}

.footer-links a:hover {
  color: #ffffff;
}
    .whispers {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  pointer-events: none;
  z-index: 0;
}

.whispers span {
  position: absolute;
  color: rgba(255, 255, 255, 0.25); /* üî• jaƒça vidljivost */
  font-size: 20px; /* malo veƒái font */
  font-family: 'VT323', monospace;
  text-shadow: 0 0 6px rgba(255, 255, 255, 0.1); /* lagani sjaj */
  animation: whisperMove 15s linear infinite;
  opacity: 0;
}

@keyframes whisperMove {
  0% { opacity: 0; transform: translateY(0); }
  10% { opacity: 0.4; }
  50% { opacity: 0.2; transform: translateY(-40px); }
  90% { opacity: 0; }
  100% { opacity: 0; transform: translateY(-80px); }
}
    /* ghost "shhh..." */
.shhh-ghost{
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: rgba(255,255,255,0.28);
  font-family: 'VT323', monospace;
  font-size: 32px;                 /* pojaƒçaj/smanji po ≈æelji */
  letter-spacing: 1px;
  opacity: 0;
  pointer-events: none;
  z-index: 6;                      /* iznad pozadine i whispers teksta */
  text-shadow: 0 0 6px rgba(255,255,255,0.10);
  transition: opacity 0.6s ease;
}
.shhh-ghost.show{ opacity: 1; }

      .whisper-box{
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  margin-top: 25px;
  margin-bottom: 25px;
  width: 100%;
}

#whisperInput{
  width: min(600px, 90vw);
  padding: 10px 12px;
  border: 1px solid #2a2a2a;
  background: rgba(12,12,12,.8);
  color: #eaeaea;
  font-family: 'VT323', monospace;
  font-size: 18px;
  outline: none;
  border-radius: 6px;
  transition: border-color .2s ease, background .2s ease;
}
#whisperInput::placeholder{ color:#6f6f6f; }

#whisperInput:focus{
  border-color:#555;
  background: rgba(18,18,18,.9);
}

#whisperSend{
  padding: 10px 14px;
  border: 1px solid #2a2a2a;
  background: rgba(18,18,18,.85);
  color:#cfcfcf;
  font-family: 'VT323', monospace;
  font-size:18px;
  border-radius:6px;
  cursor:pointer;
  transition: transform .08s ease, background .2s ease, color .2s;
}
#whisperSend:hover{ background:#1b1b1b; color:#fff; }
#whisperSend:active{ transform: translateY(1px); }

.whisper-note{
  width: 100%;
  text-align: center;
  font-size: 14px;
  color:#6f6f6f;
  margin-top: 6px;
  opacity:.8;
}

.whisper-status{
  width:100%;
  text-align:center;
  font-size:16px;
  color:#a8ffa8;
  margin-top:8px;
  min-height: 1em; /* da ne ‚Äúskaƒçe‚Äù layout */
  visibility: hidden;
}
.whisper-status.show{ visibility: visible; }

.user-whisper {
  color: rgba(255, 255, 255, 0.65) !important; /* jaƒçe vidljiv */
  text-shadow: 0 0 8px rgba(255,255,255,0.15);
  font-size: 22px !important;
  letter-spacing: 1px;
}
    .content small {
  display: block;
  margin-top: 10px;
  font-size: 18px;
  color: rgba(255,255,255,0.65);
}

    .wallet-row{
  margin-top:10px;
  display:flex; gap:10px; align-items:center; justify-content:center;
  opacity:.9;
}
#walletStatus{ color:#9c9c9c; font-size:14px; }

.admin-bar{
  margin-top:10px;
  display:flex; gap:10px; align-items:center; justify-content:center;
  font-size:14px; color:#bbb;
}
#toggleMode{
  padding:6px 10px; font-family:'VT323', monospace;
  border:1px solid #2a2a2a; background:#0b0b0b; color:#fff; border-radius:6px;
}

/* zakljuƒçan UI */
#whisperInput[disabled]{ opacity:.6; cursor:not-allowed; }
#whisperSend[disabled]{ opacity:.6; cursor:not-allowed; }
    .color-row{
  margin-top:10px;
  display:flex; gap:10px; align-items:center; justify-content:center;
  color:#cfcfcf;
}
#colorWhisperBtn{
  padding:6px 10px;
  border-radius:6px;
  background:linear-gradient(90deg,#111,#222);
  color:#fff;
  border:1px solid rgba(255,255,255,0.06);
  font-family:'VT323', monospace;
  cursor: pointer;
}
#colorWhisperBtn[disabled] {
  opacity: 0.6;
  cursor: not-allowed;
  background: #222;
}
#colorStatus{ font-size:13px; color:#9c9c9c; }
  #checkStatusBtn {
    padding: 4px 8px; font-size: 13px; background: #222; border: 1px solid #333; color: #bbb; border-radius: 4px; font-family: 'VT323', monospace; cursor: pointer;
  }
  #checkStatusBtn:hover { background: #333; color: #fff; }

    /* === NOVI STILOVI ZA WHISPRBOT === */
    .hidden { display: none !important; }
    #showAiBtn {
        margin-top: 20px;
        padding: 8px 16px;
        font-size: 18px;
        background: linear-gradient(90deg, #1a1a1a, #2b2b2b);
        border: 1px solid #a8ffa8;
        color: #a8ffa8;
        cursor: pointer;
        border-radius: 6px;
        font-family: 'VT323', monospace;
    }
    #ai-content { width: 100%; display: flex; flex-direction: column; align-items: center; }
    .ai-chat-container {
        margin-top: 20px;
        width: min(600px, 90vw);
        border: 1px solid #2a2a2a;
        background: rgba(10, 10, 10, 0.85);
        border-radius: 8px;
        padding: 15px;
        font-family: 'VT323', monospace;
    }
    .ai-chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .ai-chat-header h2 { margin: 0; font-size: 24px; color: #a8ffa8; }
    #hideAiBtn { background: none; border: none; font-size: 24px; color: #777; cursor: pointer; }
    #hideAiBtn:hover { color: #fff; }

    .ai-chat-history { height: 200px; overflow-y: auto; margin-bottom: 15px; padding-right: 10px; display: flex; flex-direction: column; gap: 10px; text-align: left; font-size: 16px; }
    .ai-chat-history p { font-size: 16px; margin: 0; }
    .ai-chat-history .user-q { color: #888; }
    .ai-chat-history .bot-a { color: #a8ffa8; }

    .ai-input-row { display: flex; gap: 10px; }
    #aiQuestionInput { flex-grow: 1; background: rgba(0,0,0,0.5); border: 1px solid #333; color: #eee; padding: 8px 10px; border-radius: 4px; font-family: 'VT323', monospace; font-size: 16px; }
    #aiQuestionInput:focus { outline: none; border-color: #555; }
    #aiAskButton { padding: 8px 12px; background: #222; border: 1px solid #333; color: #bbb; cursor: pointer; border-radius: 4px; font-family: 'VT323', monospace; font-size: 16px; }
    #aiAskButton:hover:not(:disabled) { background: #333; color: #fff; }
    #aiAskButton:disabled { opacity: 0.5; cursor: not-allowed; }

    .ai-status { font-size: 14px; color: #777; margin-top: 8px; min-height: 1em; }
    .ai-sub-row { margin-top: 15px; text-align: center; }
    #aiSubButton { width: 100%; padding: 8px; font-size: 14px; background: linear-gradient(90deg, #1a1a1a, #2b2b2b); border: 1px solid #444; color: #a8ffa8; cursor: pointer; border-radius: 4px; font-family: 'VT323', monospace; }
    #aiSubButton:disabled { opacity: 0.5; cursor: not-allowed; }
    #aiSubStatus { font-size: 13px; color: #9c9c9c; display: block; margin-top: 6px; min-height: 1em; }
  </style>
</head>
<body>
  <div class="matrix-lines"></div>
   <div class="whispers">
    <span>it started again.</span>
    <span>can you hear it?</span>
    <span>they woke it up.</span>
    <span>not again...</span>
    <span>silence speaks first.</span>
  </div>
  
  <div class="content">
    
    <!-- === GLAVNI SADR≈ΩAJ (VIDLJIV ODMAH) === -->
    <div id="main-content">
      <h1>whispr</h1>
      <small>the value is in silence. üîá</small>
      
      <div class="whisper-box">
        <input id="whisperInput" type="text" maxlength="140" placeholder="send a whispr.">
        <button id="whisperSend" aria-label="send whisper">send üîá</button>
        <div class="whisper-note" aria-hidden="true">anonymous ¬∑ not saved</div>
        <div id="whisperStatus" class="whisper-status" aria-live="polite"></div>
      </div>
      
      <div class="color-row">
        <button id="colorWhisperBtn" type="button">‚ú® Get colored whispers ‚Äî 0.01 SOL / 24 h</button>
        <span id="colorStatus">no color active</span>
      </div>
      
      <div class="color-row" style="margin-top: 8px; gap: 8px;">
        <span style="font-size: 13px; color: #9c9c9c;">Already paid?</span>
        <button id="checkStatusBtn" type="button">Check Status</button>
      </div>

      <button id="showAiBtn">Try WhisprBot AI</button>
    </div>

    <!-- === AI CHAT SADR≈ΩAJ (SKRIVEN) === -->
    <div id="ai-content" class="hidden">
      <div class="ai-chat-container">
        <div class="ai-chat-header">
          <h2>WhisprBot AI</h2>
          <button id="hideAiBtn" title="Back to main page">√ó</button>
        </div>
        <div id="aiChatHistory" class="ai-chat-history">
          <!-- Poruke se dodaju dinamiƒçki -->
        </div>
        <div class="ai-input-row">
          <input id="aiQuestionInput" type="text" placeholder="ask the silence...">
          <button id="aiAskButton">ask</button>
        </div>
        <div id="aiStatus" class="ai-status">connect wallet to begin...</div>
        <div class="ai-sub-row">
          <button id="aiSubButton">Subscribe for unlimited answers ‚Äî 0.01 SOL / month</button>
          <span id="aiSubStatus"></span>
        </div>
      </div>
    </div>

  </div>

  <div class="footer-links">
    <a href="https://x.com/whisprcoin" target="_blank">x</a>
    <a href="#" target="_blank">solscan (soon)</a>
  </div>

  <script>
  const whispers = document.querySelectorAll('.whispers span');
  function randomizeWhispers() {
    whispers.forEach(w => {
      w.style.top = Math.random() * 100 + '%';
      w.style.left = Math.random() * 100 + '%';
      w.style.animationDelay = (Math.random() * 10) + 's';
    });
  }
  randomizeWhispers();
  setInterval(randomizeWhispers, 15000);
</script>
   <script>
  // kreira i prika≈æe "shhh..." pa ga makne
  function spawnShhh(){
    // makni postojeƒái ako veƒá traje (sprijeƒçi spam)
    const old = document.querySelector('.shhh-ghost');
    if (old) old.remove();

    const s = document.createElement('div');
    s.className = 'shhh-ghost';
    s.textContent = 'shhh...';
    document.body.appendChild(s);

    // fade in
    requestAnimationFrame(() => s.classList.add('show'));

    // nakon 1.4s poƒçni gasiti, pa ukloni
    setTimeout(() => {
      s.classList.remove('show');
      setTimeout(() => s.remove(), 600);
    }, 1400);
  }

  // ciljaj H1 unutar .content (tvoj "whispr")
  const titleEl = document.querySelector('.content h1');

  if (titleEl){
    // hover na desktopu
    titleEl.addEventListener('mouseenter', spawnShhh);
    // tap na mobitelu
    titleEl.addEventListener('touchstart', spawnShhh, {passive:true});
  }
</script>
<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-functions-compat.js"></script>

<!-- Buffer polyfill -->
<script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>

<!-- ‚úÖ OVAJ NOVI FAJL MORA BITI IZMEƒêU buffer.min.js i web3.js -->
<script src="./buffer-shim.js?v=1.0.1"></script>

<!-- Solana web3 IIFE (nakon buffer-setup.js) -->
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.2/lib/index.iife.min.js" crossorigin="anonymous"></script>
 <script>
 // ‚úÖ ADD: Lightweight profanity filter library
const Filter=(function(){function e(e){this.list=e||[],this.placeHolder="*",this.regex=/@|\$|\\|\*/g,this.replaceRegex=/\w/g}return e.prototype.isProfane=function(e){for(var t=0;t<this.list.length;t++)if(new RegExp("\\b"+this.list[t].replace(/(\W)/g,"\\$1")+"\\b","gi").test(e))return!0;return!1},e.prototype.replaceWord=function(e){return e.replace(this.regex,"").replace(this.replaceRegex,this.placeHolder)},e.prototype.clean=function(e){return e.split(" ").map(function(e){return this.isProfane(e)?this.replaceWord(e):e}.bind(this)).join(" ")},e.prototype.addWords=function(){var e=Array.from(arguments);this.list=this.list.concat(e)},e.prototype.removeWords=function(){for(var e=Array.from(arguments),t=0;t<e.length;t++)for(var r=e[t],i=this.list.length-1;i>=0;i--)this.list[i]===r&&this.list.splice(i,1)},e})();

(function(){
  console.log('[whispr] boot');

  // 1) Init kad se sve uƒçita (da elementi postoje)
  window.addEventListener('load', function(){
    console.log('[whispr] dom ready');

    // 2) Firebase config
    const cfg = {
      apiKey: "AIzaSyD1R-5ltVcfW8PiuoJ4d7Kt2kouIS0M4Do",
      authDomain: "whisprcoin.firebaseapp.com",
      databaseURL: "https://whisprcoin-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "whisprcoin",
      storageBucket: "whisprcoin.firebasestorage.app",
      messagingSenderId: "1063673504189",
      appId: "1:1063673504189:web:938b00b8a6871b0a5db2d4",
      measurementId: "G-ZYWYEXVG4F"
    };

    if (!window.firebase) { console.error('[whispr] Firebase SDK nije uƒçitan'); return; }
    if (!firebase.apps.length) { firebase.initializeApp(cfg); console.log('[whispr] firebase init OK'); }
    const db = firebase.database();

    // === Cloud Functions (us-central1) ===
    const fns = firebase.app().functions('us-central1');
    const getPassStatus   = fns.httpsCallable('getPassStatus');
    const getBlockhash = fns.httpsCallable('getBlockhash');
    const confirmAndVerifyPayment = fns.httpsCallable('confirmAndVerifyPayment');
    const sendWhisperFn = fns.httpsCallable('sendWhisper');
    // NOVO: Funkcije za AI Bota
    const askWhisprBotFn = fns.httpsCallable('askWhisprBot');
    const confirmAndVerifyAiSubscription = fns.httpsCallable('confirmAndVerifyAiSubscription');


    // === UI elementi ===
    const mainContent = document.getElementById('main-content');
    const aiContent = document.getElementById('ai-content');
    const showAiBtn = document.getElementById('showAiBtn');
    const hideAiBtn = document.getElementById('hideAiBtn');
    
    const colorBtn    = document.getElementById('colorWhisperBtn');
    const colorStatus = document.getElementById('colorStatus');
    const checkStatusBtn = document.getElementById('checkStatusBtn');

    const aiChatHistory = document.getElementById('aiChatHistory');
    const aiQuestionInput = document.getElementById('aiQuestionInput');
    const aiAskButton = document.getElementById('aiAskButton');
    const aiStatus = document.getElementById('aiStatus');
    const aiSubButton = document.getElementById('aiSubButton');
    const aiSubStatus = document.getElementById('aiSubStatus');


    // === Globalno stanje ===
    let userPubkey = null;
    let passActive = false;
    let passUntil  = 0;
    let aiSubActive = false;
    let aiSubUntil = 0;
    let freeMessagesUsed = 0;
    const AI_FREE_MESSAGE_LIMIT = 5;
    const profanityFilter = new Filter();

    // === UI Toggling (Prikazivanje/skrivanje AI chata) ===
    showAiBtn.addEventListener('click', () => {
      mainContent.classList.add('hidden');
      aiContent.classList.remove('hidden');
    });
    hideAiBtn.addEventListener('click', () => {
      aiContent.classList.add('hidden');
      mainContent.classList.remove('hidden');
    });

    function renderColorStatus() {
      if (!colorStatus) return;
      if (passActive && passUntil > Date.now()) {
        const mins = Math.max(0, Math.ceil((passUntil - Date.now())/60000));
        colorStatus.textContent = `‚úÖ color ACTIVE (~${mins} min left)`;
      } else {
        passActive = false; // Ensure pass is marked as inactive if time is up
        colorStatus.textContent = 'no color active';
      }
    }

    const handleWalletReady = () => {
        const provider = window.solana;
        if (provider?.isPhantom && provider.publicKey) {
            console.log('[whispr] Phantom wallet is already connected.');
            afterWalletConnected(provider.publicKey.toString());
        } else {
            console.log('[whispr] Phantom wallet not connected on load.');
            updateAiStatus(); // A≈æuriraj AI status i za nepovezanog korisnika
        }
    };

    if (window.solana?.isPhantom) {
        handleWalletReady();
    } else {
        window.addEventListener('solana#initialized', handleWalletReady, { once: true });
    }

    async function afterWalletConnected(pubkey){
      userPubkey = pubkey;
      colorStatus.textContent = 'checking status‚Ä¶';
      aiStatus.textContent = 'checking status...';
      try {
        // ‚úÖ FINAL FIX: Jedan siguran poziv dohvaƒáa SVE potrebne podatke.
        const { data } = await getPassStatus({ userPubkey });
        console.log('[whispr] getPassStatus response:', data);

        // Postavi status za Color Pass
        passActive = !!data.colorPass?.active;
        passUntil  = data.colorPass?.active_until || 0;
        renderColorStatus();

        // Postavi status za AI Sub
        aiSubActive = !!data.aiSub?.active;
        aiSubUntil = data.aiSub?.active_until || 0;
        freeMessagesUsed = data.aiSub?.free_messages_used || 0;
        
        // A≈æuriraj UI za AI
        updateAiStatus();

      } catch (e) {
        console.error('[whispr] getPassStatus error:', e);
        colorStatus.textContent = 'status check failed';
        aiStatus.textContent = 'status check failed';
      }
    }

    async function onCheckStatusClick() {
        const provider = window.solana;
        if (!provider?.isPhantom) {
            alert('Phantom wallet not installed.');
            return;
        }
        if (!provider.publicKey) {
            try {
                await provider.connect({ onlyIfTrusted: true });
            } catch (err) {
                colorStatus.textContent = 'please connect wallet first';
                return;
            }
        }
        if (provider.publicKey) {
            await afterWalletConnected(provider.publicKey.toString());
        } else {
            colorStatus.textContent = 'connect wallet first';
        }
    }

    async function onColorBtnClick() {
      const provider = window.solana;
      const MERCHANT = 'DstrKLkb6W6wYfDyDoMBmgDCTwkh2R4RWv6aQasWUj2F';
      const PRICE_SOL = 0.01;

      if (!provider?.isPhantom) { alert('Phantom wallet nije instaliran.'); return; }
      if (!window.solanaWeb3)   { alert('Solana web3 nije uƒçitan (hard refresh).'); return; }

      try {
        colorBtn.disabled = true;
        if (!provider.publicKey) {
          const resp = await provider.connect();
          userPubkey = resp.publicKey.toString();
          await afterWalletConnected(userPubkey);
        } else {
          userPubkey = provider.publicKey.toString();
        }
        
        if (passActive && passUntil > Date.now()) {
            colorStatus.textContent = '‚úÖ color already active!';
            setTimeout(() => { colorBtn.disabled = false; renderColorStatus(); }, 1500);
            return;
        }

        colorStatus.textContent = 'getting blockhash‚Ä¶';
        const bh = await getBlockhash();
        const blockhash = bh?.data?.blockhash;
        const lastValidBlockHeight = bh?.data?.lastValidBlockHeight;
        if (!blockhash || !lastValidBlockHeight) {
          throw new Error('No blockhash from backend');
        }

        colorStatus.textContent = 'opening Phantom‚Ä¶';
        const fromPubkey = provider.publicKey;
        const toPubkey   = new window.solanaWeb3.PublicKey(MERCHANT);
        const lamports   = Math.round(PRICE_SOL * 1_000_000_000);

        if (window.buffer?.Buffer) {
          window.Buffer = window.buffer.Buffer;
          globalThis.Buffer = window.buffer.Buffer;
        }
        if (typeof Buffer.from !== 'function' && window.buffer?.Buffer?.from) {
          Buffer.from = window.buffer.Buffer.from.bind(window.buffer.Buffer);
        }
        
        const tx = new window.solanaWeb3.Transaction({
          feePayer: fromPubkey,
          recentBlockhash: blockhash,
        }).add(
          window.solanaWeb3.SystemProgram.transfer({ fromPubkey, toPubkey, lamports })
        );

        colorStatus.textContent = 'awaiting approval in Phantom‚Ä¶';
        const { signature } = await provider.signAndSendTransaction(tx);
        
        colorStatus.textContent = 'confirming and verifying‚Ä¶';
        const { data } = await confirmAndVerifyPayment({
          userPubkey,
          signature,
          blockhash,
          lastValidBlockHeight
        });

        if (data?.ok) {
          passActive = true;
          passUntil  = data.active_until || 0;
          renderColorStatus();
        } else {
          colorStatus.textContent = `‚ùå ${data?.reason || 'verification failed'}`;
        }
        colorBtn.disabled = false;
      } catch (e) {
        console.error('Payment error:', e);
        colorStatus.textContent = '‚ùå cancelled or failed';
        colorBtn.disabled = false;
      }
    }

    colorBtn?.addEventListener('click', onColorBtnClick);
    checkStatusBtn?.addEventListener('click', onCheckStatusClick);

    // === WhisprBot AI Logika ===
    function addMessageToChat(message, type) {
      if (!aiChatHistory) return;
      const p = document.createElement('p');
      p.textContent = message;
      p.className = type;
      aiChatHistory.appendChild(p);
      aiChatHistory.scrollTop = aiChatHistory.scrollHeight;
    }

    function updateAiStatus() {
      if (!userPubkey) {
        aiStatus.textContent = 'connect wallet to begin...';
        aiAskButton.disabled = true;
        aiSubButton.disabled = true;
        return;
      }
      aiSubButton.disabled = false;
      if (aiSubActive) {
        const daysLeft = Math.ceil((aiSubUntil - Date.now()) / (1000 * 60 * 60 * 24));
        aiStatus.textContent = `Subscribed! Unlimited questions. (~${daysLeft} days left)`;
        aiSubStatus.textContent = `‚úÖ Subscription active.`;
        aiAskButton.disabled = false;
        aiSubButton.textContent = 'Subscription Active';
        aiSubButton.disabled = true;
      } else {
        const remaining = Math.max(0, AI_FREE_MESSAGE_LIMIT - freeMessagesUsed);
        aiStatus.textContent = `You have ${remaining} free questions remaining.`;
        aiSubStatus.textContent = '';
        aiAskButton.disabled = remaining <= 0;
        aiSubButton.textContent = 'Subscribe for unlimited answers ‚Äî 0.01 SOL / month';
        if (remaining <= 0) {
          aiStatus.textContent = 'Free limit reached. Subscribe for more.';
        }
      }
    }

    async function askBot() {
      const question = aiQuestionInput.value.trim();
      if (!question || !userPubkey || aiAskButton.disabled) return;
      addMessageToChat(`> ${question}`, 'user-q');
      aiQuestionInput.value = '';
      aiAskButton.disabled = true;
      aiStatus.textContent = 'thinking...';
      try {
        const { data } = await askWhisprBotFn({ question, userPubkey });
        if (data.ok) {
          addMessageToChat(data.answer, 'bot-a');
          if (!aiSubActive) freeMessagesUsed++;
        } else {
          addMessageToChat(`... ${data.reason || 'an error occurred'} ...`, 'bot-a');
        }
      } catch (e) {
        console.error('[whispr] askBot error:', e);
        addMessageToChat(`... ${e.message || 'the static is too loud...'}`, 'bot-a');
      } finally {
        updateAiStatus();
      }
    }
    
    addMessageToChat('...i am listening...', 'bot-a');
    updateAiStatus();

    aiAskButton?.addEventListener('click', askBot);
    aiQuestionInput?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); askBot(); } });

    async function onAiSubClick() {
      const provider = window.solana;
      const MERCHANT = 'DstrKLkb6W6wYfDyDoMBmgDCTwkh2R4RWv6aQasWUj2F';
      const PRICE_SOL = 0.01;

      if (!provider?.isPhantom) { alert('Phantom wallet nije instaliran.'); return; }
      if (!window.solanaWeb3)   { alert('Solana web3 nije uƒçitan (hard refresh).'); return; }

      try {
        aiSubButton.disabled = true;
        if (!provider.publicKey) {
          const resp = await provider.connect();
          userPubkey = resp.publicKey.toString();
          await afterWalletConnected(userPubkey);
        } else {
          userPubkey = provider.publicKey.toString();
        }
        
        if (aiSubActive) {
          aiSubStatus.textContent = 'You are already subscribed.';
          return;
        }

        aiSubStatus.textContent = 'getting blockhash‚Ä¶';
        const bh = await getBlockhash();
        const blockhash = bh?.data?.blockhash;
        const lastValidBlockHeight = bh?.data?.lastValidBlockHeight;
        if (!blockhash || !lastValidBlockHeight) throw new Error('No blockhash from backend');

        aiSubStatus.textContent = 'opening Phantom‚Ä¶';
        const fromPubkey = provider.publicKey;
        const toPubkey   = new window.solanaWeb3.PublicKey(MERCHANT);
        const lamports   = Math.round(PRICE_SOL * 1_000_000_000);
        
        const tx = new window.solanaWeb3.Transaction({
          feePayer: fromPubkey,
          recentBlockhash: blockhash,
        }).add(
          window.solanaWeb3.SystemProgram.transfer({ fromPubkey, toPubkey, lamports })
        );

        aiSubStatus.textContent = 'awaiting approval in Phantom‚Ä¶';
        const { signature } = await provider.signAndSendTransaction(tx);
        
        aiSubStatus.textContent = 'confirming and verifying‚Ä¶';
        const { data } = await confirmAndVerifyAiSubscription({
          userPubkey,
          signature,
          blockhash,
          lastValidBlockHeight
        });

        if (data?.ok) {
          aiSubActive = true;
          aiSubUntil  = data.active_until || 0;
          updateAiStatus();
        } else {
          aiSubStatus.textContent = `‚ùå ${data?.reason || 'verification failed'}`;
        }
      } catch (e) {
        console.error('AI Sub Payment error:', e);
        aiSubStatus.textContent = '‚ùå cancelled or failed';
      } finally {
        aiSubButton.disabled = aiSubActive;
      }
    }
    aiSubButton?.addEventListener('click', onAiSubClick);

    // === Logika za slanje Whispera ===
    const layer  = document.querySelector('.whispers');
    const input  = document.getElementById('whisperInput');
    const button = document.getElementById('whisperSend');
    const status = document.getElementById('whisperStatus');

    function floatWhisper(text, strong, colored = false){
      if (!layer) return;
      const s = document.createElement('span');
      s.textContent = text;
      s.style.position = 'absolute';
      s.style.top  = (10 + Math.random()*80) + '%';
      s.style.left = (5 + Math.random()*90) + '%';
      s.style.setProperty('--whisper-glow-color', colored ? '#a8ffa8' : 'rgba(255,255,255,0.1)');
      s.style.color = colored ? '#a8ffa8' : (strong ? 'rgba(255,255,255,0.55)' : 'rgba(255,255,255,0.35)');
      s.style.textShadow = '0 0 10px var(--whisper-glow-color)';
      s.style.fontSize = (18 + Math.floor(Math.random()*6)) + 'px';
      s.style.animation = 'whisperMove 12s linear 1';
      s.style.opacity = '0';
      layer.appendChild(s);
      setTimeout(()=>s.remove(), 12000);
    }

    async function sendWhisper(){
      const text = (input.value || '').trim();
      if (!text) return;

      if (profanityFilter.isProfane(text)) {
          status.textContent = '‚ùå inappropriate language';
          status.classList.add('show');
          setTimeout(() => {
              status.classList.remove('show');
              status.textContent = '';
          }, 2500);
          return;
      }

      input.disabled = true;
      button.disabled = true;
      status.textContent = 'sending...';
      status.classList.add('show');

      try {
        const { data } = await sendWhisperFn({ text, userPubkey });
        if (data.ok) {
          status.textContent = 'sent.';
        } else {
          status.textContent = `‚ùå ${data.reason || 'Could not send'}`;
        }
      } catch (e) {
        status.textContent = '‚ùå error sending.';
      }

      input.value = '';
      setTimeout(() => {
        input.disabled = false;
        button.disabled = false;
        status.classList.remove('show');
        status.textContent = '';
      }, 2000);
    }
    
    setInterval(async () => {
      try {
        const snap = await db.ref('whispers').once('value');
        const data = snap.val();
        if (!data) return;
        const now = Date.now();
        const cutoff = now - 20000;
        Object.entries(data).forEach(([key, val]) => {
          if (val.time < cutoff) {
            db.ref('whispers/' + key).remove();
          }
        });
      } catch (e) {
        console.error('[whispr] auto-clean error:', e);
      }
    }, 20000);

    button.addEventListener('click', sendWhisper);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter'){ e.preventDefault(); sendWhisper(); }
    });
  
    db.ref('whispers').orderByChild('time').limitToLast(20).on('child_added', snap => {
      const item = snap.val();
      if (!item || !item.text) return;
      floatWhisper(item.text, false, !!item.colored);
    });

    db.ref('connection-test').set({ok:true, t:Date.now()})
      .then(()=>console.log('[whispr] test write OK'))
      .catch(err=>console.error('[whispr] test write FAIL', err));
  });
})();
</script>
</body>
</html>






































































































